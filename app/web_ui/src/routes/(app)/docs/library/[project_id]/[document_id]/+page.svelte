<script lang="ts">
  import AppPage from "../../../../app_page.svelte"
  import { base_url, client } from "$lib/api_client"
  import type { ExtractionSummary, KilnDocument } from "$lib/types"
  import { KilnError, createKilnError } from "$lib/utils/error_handlers"
  import { onMount } from "svelte"
  import { page } from "$app/stores"
  import { formatDate, formatSize } from "$lib/utils/formatters"
  import Dialog from "$lib/ui/dialog.svelte"
  import PropertyList from "$lib/ui/property_list.svelte"
  import DeleteDialog from "$lib/ui/delete_dialog.svelte"
  import { isMacOS } from "$lib/utils/platform"
  import { goto } from "$app/navigation"
  import Output from "../../../../run/output.svelte"
  import { capitalize } from "$lib/utils/formatters"

  let document: KilnDocument | null = null
  let error: KilnError | null = null
  let loading = true
  let results: ExtractionSummary[] | null = null

  $: project_id = $page.params.project_id
  $: document_id = $page.params.document_id

  // dialog state
  let output_dialog: Dialog | null = null
  let dialog_extraction: ExtractionSummary | null = null

  $: download_document_url = `${base_url}/api/projects/${project_id}/documents/${document_id}/download`

  onMount(async () => {
    get_document()
    get_extractions()
  })

  async function get_document() {
    try {
      loading = true
      if (!project_id) {
        throw new Error("Project ID not set.")
      }
      const { data: document_response, error: get_error } = await client.GET(
        "/api/projects/{project_id}/documents/{document_id}",
        {
          params: {
            path: {
              project_id,
              document_id,
            },
          },
        },
      )
      if (get_error) {
        throw get_error
      }
      document = document_response
    } catch (e) {
      if (e instanceof Error && e.message.includes("Load failed")) {
        error = new KilnError(
          "Could not load dataset. It may belong to a project you don't have access to.",
          null,
        )
      } else {
        error = createKilnError(e)
      }
    } finally {
      loading = false
    }
  }

  async function get_extractions() {
    try {
      loading = true
      const { data: extractions_response, error: get_error } = await client.GET(
        "/api/projects/{project_id}/documents/{document_id}/extractions",
        {
          params: {
            path: {
              project_id,
              document_id,
            },
          },
        },
      )
      if (get_error) {
        throw get_error
      }
      results = extractions_response
    } finally {
      loading = false
    }
  }

  async function open_enclosing_folder() {
    try {
      loading = true
      const { error: open_error } = await client.POST(
        "/api/projects/{project_id}/documents/{document_id}/open_enclosing_folder",
        {
          params: {
            path: {
              project_id,
              document_id,
            },
          },
        },
      )
      if (open_error) {
        throw createKilnError(open_error)
      }
    } finally {
      loading = false
    }
  }

  let delete_document_dialog: DeleteDialog | null = null
  $: delete_document_url = `/api/projects/${project_id}/documents/${document_id}`
  function after_document_delete() {
    goto(`/docs/library/${project_id}`)
  }

  let delete_extraction_id: string | null = null
  let delete_extraction_dialog: DeleteDialog | null = null
  $: delete_extraction_url = `/api/projects/${project_id}/documents/${document_id}/extractions/${delete_extraction_id}`
  async function after_delete_extraction() {
    get_extractions()
  }
</script>

<AppPage
  title="Document"
  subtitle={`${document?.name || document?.original_file.filename}`}
  action_buttons={[
    {
      icon: "/images/download.svg",
      href: download_document_url || "",
    },
    {
      icon: "/images/folder.svg",
      handler: () => {
        open_enclosing_folder()
      },
    },
    {
      icon: "/images/delete.svg",
      handler: () => delete_document_dialog?.show(),
      shortcut: isMacOS() ? "Backspace" : "Delete",
    },
  ]}
>
  {#if loading}
    <div class="w-full min-h-[50vh] flex justify-center items-center">
      <div class="loading loading-spinner loading-lg"></div>
    </div>
  {:else if document}
    <div class="flex flex-col xl:flex-row gap-8 xl:gap-16">
      {#if results}
        <div class="flex-grow">
          <div class="text-xl font-bold">Document Extractions</div>
          <div class="text-gray-500 text-sm">
            Each
            <a class="link" href={`/docs/extractors/189194447826`}
              >document extractor</a
            > generated extractions of this document:
          </div>
          {#if results.length == 0}
            <div class="mt-4 text-sm text-gray-500">
              No extractions found for this document.
            </div>
          {:else}
            <div class="text-sm overflow-x-auto rounded-lg border mt-4">
              <table class="table">
                <thead>
                  <tr>
                    <th>Extraction Details</th>
                    <th>Extraction Output</th>
                  </tr>
                </thead>
                <tbody>
                  {#each results as result}
                    <tr>
                      <td>
                        <div
                          class="grid grid-cols-[auto_1fr] gap-y-2 gap-x-4 text-sm"
                        >
                          <div>ID</div>
                          <div class="text-gray-500">{result.id}</div>
                          <div>Source</div>
                          <div class="text-gray-500">
                            {#if result.source == "processed"}
                              Model Output
                            {:else if result.source == "passthrough"}
                              Unprocessed (Original)
                            {:else}
                              {result.source}
                            {/if}
                          </div>
                          <div>Extractor</div>
                          <div class="text-gray-500">
                            <a
                              href={`/docs/extractors/${project_id}/${result.extractor.id}/extractor`}
                              class="link"
                            >
                              {result.extractor.name}
                            </a>
                          </div>
                          <div>Actions</div>
                          <div class="text-gray-500">
                            <button
                              class="link"
                              on:click={() => {
                                delete_extraction_id = result.id || null
                                delete_extraction_dialog?.show()
                              }}
                            >
                              Delete
                            </button>
                          </div>
                        </div>
                      </td>
                      <td>
                        <div class="min-w-[200px]">
                          {#if result.output_content.length > 200}
                            <button
                              class="w-full h-[160px] overflow-y-hidden relative text-start justify-start items-start flex"
                              on:click={() => {
                                dialog_extraction = result
                                output_dialog?.show()
                              }}
                            >
                              {result.output_content}
                              <div class="absolute bottom-0 left-0 w-full">
                                <div
                                  class="h-36 bg-gradient-to-t from-white to-transparent"
                                ></div>
                                <div
                                  class="text-center bg-white font-medium font-sm text-gray-500"
                                >
                                  <span class="text-gray-500"> See all </span>
                                </div>
                              </div>
                            </button>
                          {:else}
                            <div
                              class="text-sm text-gray-500 font-mono text-xs"
                            >
                              {result.output_content}
                            </div>
                          {/if}
                        </div>
                      </td>
                    </tr>
                  {/each}
                </tbody>
              </table>
            </div>
          {/if}
        </div>
      {/if}

      <div class="w-72 2xl:w-96 flex-none flex flex-col gap-4">
        <PropertyList
          properties={[
            { name: "ID", value: document.id || "Unknown" },
            { name: "Name", value: document.name },
            {
              name: "Original Filename",
              value: document.original_file.filename,
            },
            {
              name: "Original File Size",
              value: formatSize(document.original_file.size),
            },
            {
              name: "Kind",
              value: capitalize(document.kind),
            },
            { name: "MIME Type", value: document.original_file.mime_type },
            { name: "Created At", value: formatDate(document.created_at) },
            { name: "Created By", value: document.created_by || "Unknown" },
            { name: "Description", value: document.description || "None" },
          ]}
          title="Properties"
        />
        <div class="mt-4 flex flex-row items-center gap-2">
          {#if document.tags}
            {#each document.tags as tag}
              <div
                class="badge bg-gray-200 py-3 px-3 max-w-full text-sm text-gray-500"
              >
                {tag}
              </div>
            {/each}
          {/if}
        </div>
      </div>
    </div>
  {:else if error}
    <div
      class="w-full min-h-[50vh] flex flex-col justify-center items-center gap-2"
    >
      <div class="font-medium">Error Loading Document</div>
      <div class="text-error text-sm">
        {error.getMessage() || "An unknown error occurred"}
      </div>
    </div>
  {/if}
</AppPage>

<Dialog
  bind:this={output_dialog}
  title="Extraction Output"
  action_buttons={[
    {
      label: "Close",
      isCancel: true,
    },
  ]}
>
  {#if dialog_extraction}
    <div class="mb-2 text-sm text-gray-500">
      The extractor produced the following output:
    </div>
    <Output raw_output={dialog_extraction.output_content} />
  {:else}
    <div class="text-sm text-gray-500">No extraction output found.</div>
  {/if}
</Dialog>

<DeleteDialog
  name={document?.name || "Document"}
  bind:this={delete_document_dialog}
  delete_url={delete_document_url}
  after_delete={after_document_delete}
/>

<DeleteDialog
  name="Extraction"
  bind:this={delete_extraction_dialog}
  delete_url={delete_extraction_url}
  after_delete={after_delete_extraction}
/>
